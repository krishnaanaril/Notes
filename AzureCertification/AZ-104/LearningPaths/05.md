# AZ-104: Configure and manage virtual networks for Azure administrators
## Configure Virtual networks
- An Azure Virtual Network (Vnet) is a representation of your own network in the cloud.
- Each Vnet you create has its own CIDR block and can be linked to other Vnets and other on-premise networks if the CIDR block do not overlap.
- Virtual Network -> Subnet -> Virtual Machine
- Virtual networks can be used in many ways:
    - Create a dedicated private cloud-only vnet.
    - Securely extend your data center with vnets.
    - Enable hybrid cloud scenarios.
- A vnet can be segmented into one or more subnets.
- Subnets provide logical divisions within your network.
- Subnet addresspace must be provided with CIDR notation.
- There are restrictions on using IP addresses. Azure reserves 5 ip addresses within each subnet.
    - x.x.x.0 : Network Address
    - x.x.x.1 : Default Gateway 
    - x.x.x.2, x.x.x.3: To map Azure DNS ips to Vnet space
    - x.x.x.255 : Network broadcast address
- Subnet considerations
    - Service requirements
    - Virtual appliances
    - Service endpoints
    - network security groups
    - private links
- You can limit access to azrue resources to specific subnets with a virtual network service endpoint.
- You can associate zero or one network security group to each subnet in a virtual network.
- **Azure Private Link** is a secure and scalable way for Azure customers to consume Azure storage like Azure storage or SQL privately from their Azure VNet. Once connection is established, all data flow between producer and consumer stays on Microsoft network and is isolated from internet.
- By default, you can create upto **50 VNet** per subscription per region.
- There are two types of Azure IP addresses: public and private IP addresses.
- You may decide to separate dynamically and statically assigned IP resources to different subnets.
- Mixing SKUs between VMs within availability sets or scale sets or standalone VMs is not allowed.
- If you select IPv6 for IP version, the assignment method must be Dynamic for the Basic SKU.
- Standard SKU addresses are static for both IPv4 and IPv6.
- | Feature         | Basic SKU              | Standard SKU |
  |-----------------|------------------------|--------------|
  | IP assignment   | Static/Dynamic         | Static       |
  | Security        | Open by default        | secure by default <br/> and close to inbound traffic |
  | Resources       | Network Interfaces, <br/> Internet facing load balancers | Network Interface, <br/> Public standard load balancers |
  | Redundancy      | Not Zone redundant    | Zone redundant by default |
## Configure network security groups
- You can limit network traffic to resources in a virtual network using a network security group (NSG).
- You can assign NSGs to a NIC so that all the traffic that flows through that NIC is controlled by NSG rules.
- Azure creates default security rules in each security group that you create. You cannot remove default rules, but you override these by create rules with higher priorities.
- Default inbound rules deny all inbound traffic except from the virtual network and azure load balancers.
- Default outbound rules deny all outbound traffic except outbound traffic to internat and virtual network.
- For incoming traffic, NSG rules at subnet level are evaluated first followed by NSG set at NIC level. For outbound traffic, it is the reverse.
- To verify which all security rules are applied to a network interface, make use of **Effective security rules** link.
- Options for creating NSG
    - **Service** specifies the destination protocol and port range. Choose custom to provide your own port range.
    - **Port Range** can include a single port, port range or a comma separted list of ports. Asterik (*) denote any port.
    - **Priority** - lower the number higher the priority. It is recommended to provide gaps between rules to make it easier to add new rules. The value is beween 100-4096 and unique for all security rules within the NSG.
- ASGs (Application Security Group) enable you to configure network security as a natural extension of an application's structure.
- There are limits to the number of ASGs you can have in your subscription.
- You cannot specify multiple ASGs in the source or destination of a security rule.
- You cannot add network interfaces from different virtual networks to the same ASG.
- All network interfaces for both the source and destination ASGs need to exist in the same virtual network.
- VirtualNetwork is a valid service tag for NSG rules. Service tags represent a group of ip addresses.
- With ASGs you can reduce the number of NSGs in your subscription.
## Configure Azure Firewall
- Azure firewall is a managed, cloud based network security service that protects your Azure Virtual Network resources.
- Azure firewall uses static ip address for your virtual network resources.
-  Azure firewall features: 
    - Built-in high availabilty
    - Availabilty zones
    - Unrestricted cloud scalability
    - Application FQDN filtering rules
    - Network traffice filtering rules
    - Threat intelligence
    - Mulitple public ip address.
- **ExpressRoute** lets you extend your on-premises networks into the Microsoft cloud over a private connection with the help of a connectivity provider.
- It is recommended to use *hub-spoke* network topology when deploying a firewall.
- Traffic flows between on-premise datacentre and the hub through an ExpressRoute or VPN gateway connection.
- The benefits of hub-spoke topology:
    - Cost savings by centralizing services that can be shared by multiple workloads in a single location.
    - Overcome subscription limits
    - Separation of concerns between central IT and workloads.
- By defailt Azure firewall blocks all traffic.
- There are three kind of rules that you can configure in Azure firewall.
    - NAT rules
    - Network rules
    - Application rules
- You can configure Azure Firewall Destination Network Address Translation (DNAT) to translate and filter inbound traffic to your subnets.
- Any non-HTTP/S traffic that will be allowed to flow through the firewall must have a network rule.
- Application rules define FQDNs that can be accessed from a subnet
- When a packet is being inspected to determine it it is allowed or not, the rules are processed in this order:
    - Network rules
    - Application rules
- Once a rule is found that allows the traffic through, no more rules are checked.
- Use DNAT to translate Azure firewalls public ip address to the private ip address of the virtual server.
- Azure firewall uses a statically assigned public ip address.
## Configure Azure DNS
- Azure DNS enables you to host your DNS records for your domains on Azure infrastructure.
- You must be a global administrator to perform domain management tasks. Global administrator is the user who created the subscription.
- Domain names in Azure AD are globally unique.
- Azure Domain verificaiton is performed by adding a DNS record. The DNS record can **MX or TXT**.
- A DNS zone hosts the DNS records for a domain.
- The name of the Azure DNS zone must unique in a resource group.
- When multiple zones share the same name, each instance is assigned different name server addresses.
- Each time a DNS zone is created Azure DNS allocates name servers from a pool.
-  When you copy a name server make sure to copy the trailing period at the end of the address. It indicates the end of a fully qualified domain name.
- The parent and child zones can be in same or different resource group.
- A record set is a collection of records in a zone that have the same name and are the same type.
- A record set cannot contain two identical records.
- The TTL (time to live) for an A record, specifies how long each record is cached by the client before being requeried.
- Azure private DNS benefits:
    - Removes the need for custom DNS solutions.
    - Use all common DNS records types
    - Automatic hostname record management
    - Hostname resolution between virtual networks.
    - Familiar tools and UX
    - Split-horizon DNS support
    - Available in all regions
- The A or AAAA record maps ip address to a domain.
## Configure virtual network peering
- Virtual network peering enables you to seamlessly connect two Azure Virtual Networks.
- There are two types of vnet peering:
    - Regional Vnet peering
    - Global vnet peering
- Benefits of virtual network peering:
    - Private
    - Performance
    - Communication
    - Seamless
    - No disruption/downtime
- A virtual network can have only one gateway.
- Vnet peering is nontransitive.
- Service chaining enables you to direct traffic from one virtual network to a virtual appliance or gateway in a peered network through user defined routes.
-  Each subnet can have zero or one route table associated with it.
- A virtual appliance is a virtual machine that typically runs a network applicaiton, such as a firewall.
- Status of vnet peering:
    - **Initiated** - when you create the peering to the second vnet from first
    - **Connected** - when you create the perring from second vnet to first.
- The peering is not successfully established until the peering status for both virtual network peering is connected.
- The Azure backbone handles traffic between virtual networks.
## Configure VPN Gateway
- A VPN gateway is a specific type of virtual network gateway that is used to send encrypted traffic between an azure virtual network and an on-premises location over the public internet.
- Each virtual network can have only one VPN gateway.
- When you create multiple connections to the same VPN gateway, all VPN tunnels share the available gateway bandwidth.
- **Site-to-site** connections connect on-premises data centers to Azure virtual networks.
- **VNet-to-VNet** connection connect Azure virtual networks.
- **Point-to-site** connections connect individual devices to Azure virtual networks.
- You can't directly configure the VMs that are part of the gateway.
- VPN gateways can be deployed in Azure availability zones.
- The gateway subnet contains the ip addresses that are used by the virtual network gateway.
- The gateway subnet must be named *GatewaySubnet*
- There are two VPN types:
    - Route based
    - Policy based
- Limitations on policy based VPN:
    - It can only be used with Basic gateway SKU and not compatible with other gateway SKUs
    - You can have only one tunnel
- Once a virtual network gateway has been create, you cannot change the VPN type.
- The local network gateway typically refers to the on-premise location.
- If you plan to use local network gateway in a BGP enabled connection, then the minimum prefix you need to declare is the host address of your BGP peer ip address on your VPN device.
- To configure a VPN device, you need:
    - A shared key
    - The public ip address of your VPN gateway
- Depending on the VPN device you have, you may be able to download a VPN device configuration script.
- Every azure VPN gateway consists of two instances in an active-standby configuration.
- You can also create Azure VPN gateway in an active-active configuration, where both instances of the gateway VMs will establish S2S tunnels to your on-premise VPN device.
- IKEv2 is a tunneling protocol within the IPSec protocol suite.
- Typical route-based gateway scenarios include point-to-site, inter-virtual network, or multiple site-to-site connections.
- Route-based is also selected to co-exist with an expressroute gateway or when the IKEv2 protocol is used.
## Configure ExpressRoute and virtual WAN
- Azure ExpressRoute lets you extend your on-premises networks into the Microsoft cloud.
- ExpressRoute connections don't go over the public internet, and they offer more reliablity, faster speeds, and lower latencies than typical internet connections.
- ExpressRoute provide bandwidths upto 100Gbps
- ExpressRoute is supported across all Azure regions and locations.
- ExpressRoute benefits:
    - Layer 3 connectivity
    - Redundancy
    - Connectivity to Microsoft cloud services
    - Connectivity to all regions within a geopolitical region
    - Global connectivity with ExpressRoute premium add-on
    - Across on-premises connectivity with ExpressRoute Global Reach
    - Bandwidth options
    - Flexible billing models
- ExpressRoute Global Reach is designed to compliment your service provider's WAN implementation and connect your branch offices across the world.
- Azure virtual WAN is a networking service that provides optimized and automated branch connectivity to, and through azure
- Virtual WAN advantages:
    - Integrated connectivity solutions in hub and spoke
    - Automated spoke setup and configuration
    - Intuitive troubleshooting
- There are two types of virtual WAN    
    - Basic - Site-to-site VPN only
    - Standard
- ExpressRoute is best for handling enterprise-class and mission-critical workloads.
## Configure network routing and endpoints
- Azure uses **system routes** to direct network traffic between virtual machines, on-premise networks, and the internet.
- The following situations are managed by system routes:
    - Traffic between VMs in the subnet
    - Between VMs in different subnet in the same virtual network.
    - Data flow from VMs to the internet.
- Information about system routes is recorded in a route table. 
- If matching route can't be found, the the packet is dropped.
- Each route table can be associated to multiple subnets, but a subnet can only be associated to a single route table.
- There are no charges for creating route tables in azure.
- Why use a service endpoint?
    - Improved security for your Azure service resources
    - Optimal routing for Azure service traffic from your virtual network.
    - Endpoints always take service traffic directly from your virtual network to the service on Microsoft Azure backbone network.
    - Simple to step up with less management overhead.
- Azure private link provides private connectivity from a virtual network to Azure platform as service, customer owned or microsoft partner services.
- Private link keeps traffic on the microsoft global network.
- Traffic routed to the None next hop type is not routed outside the subnet, but is dropped.
- When creating user-defined routes, the valid next hop choices are virtual appliance, virtual network gateway, virtual network, internet and none.
- Virtual network endpoints extend the private address space in azure.
## Configure Azure load balancer
- The load balancer distributes inbound traffic to backend resources using **load-balancing rules** and **health probes**:
    - Load balancing rules determine how traffic is distributed to the backend.
    - Health probe ensures that the resources in backend are healthy.
- Four components that must be configured for load balancer:
    - Frontend IP configuration
    - Backend Pools
    - Health Probes
    - Load-balancing rules
- There are two types of load balancers:    
    - Public
    - Internal
- A public load balancer maps the public ip address and port number of incoming traffic to the private ip address and port number of the VM.
- An internal load balancer directs traffic to resources that are inside a virtual network or that use a VPN to access Azure infrastructure.
- The load balancer support both Basic and Standard SKUs.
- Single VM support for Backend pool endpoints are available in Standard SKU.
- Load balancing rules can be used in combination with NAT rules. For e.g. mapping public ip:port to TCP:3389 will allow user to RDP connect from outside Azure.
- By default, Azure load balancer distributes network equally among multiple VM instances.
- Load balancer uses a five-tuple to map traffic to available servers:
    - Source IP
    - Source Port
    - Destination IP
    - Destination Port
    - Protocol
- The default behaviour for session persistence (None) is that successive requests from a client may be handled by any virtual machine. This can be changed to: 
    - Client IP
    - Client IP and protocol
- There are mainly two ways to configure health probe:
    - HTTP
    - TCP
- Any HTTP status other than 200 cause the probe to fail.
- For TCP probe, if the connection is refused probe fails.
- The VMs that use a load balancer to distrubute a load to must be in the same virtual network.
## Configure Azure Application Gateway
- Application Gateway uses application layer routing.
- The application gateway uses round-robin to send load balance requests to the servers in each back end pool.
- Application gateway provides session stickyness.
- Application gateway - OSI Layer 7 - Uses routing parameters
- Azure Load Balancer - OSI Layer 4 - Uses ip address
- There are two primary methods of routing traffic:
    - Path based routing
    - Multiple site routing
- Other features:
    - Redirection
    - Rewrite HTTP headers
    - Custom error pages
- Application gateway has a series of componenets that combine to route requests to a pool of web servers and to check the health of these web servers.
    - Front-end ip address
    - Listeners
    - Routing rules
    - Back-end pools
    - Web application firewall
    - Health probes
- Applicationi gateway can't have more than one public and one private ip address.
- WAF is enabled on your application gateway by selecting the WAF tier when you create a gateway.
- Health Probe: When a server returns an HTTP response with a status code between 200 and 399, the server is considered healthy.
- If you don't configure a probe, application gateway will create a default one that waits for 30 seconds.
## Design an ip addressing schema for your Azure deployment
- A good ip addressing scheme provides flexibility, room for growth and integration with on-premises network.
- A typical on-premise network design includes:
    - Router
    - Firewalls
    - Switches
    - Network Segmentation
- There are three ranges of non-routable IP addresses that are designed for internal networks that won't be sent over internet routes:
    - 10.0.0.0 to 10.255.255.255
    - 172.16.0.0 to 172.31.255.255
    - 192.168.0.1 to 192.168.255.255
- The number of subnets and IP addresses you can have in your on-premises network depends on the CIDR for the IP address block.
- Typical components involved in a network design include a VM, subnet, firewall and loadbalancer.
- You can use NSG to deny communication between subnets, by default it is allowed.
- Private and Public addresses can be allocated in one of two ways:
    - Dynamic
    - Static
- For public IP addresses, there are two SKUs to choose from: Basic and  Standard.
- Prior to introduction of SKU, everything was Basic type.
- Both Basic & Standard SKus:
    - Have a default inbound originated flow idle timeout of 4 minutes, which is adjustable to up to 30 mins.
    - Have a fixed outbound originated flow of 4 mins.
- Basic SkU: 
    - Don't support availabilty zones.
    - Don't support routing preferences
    - Are Open
- Standard SKus:
    - Are closed to inbound traffic
    - Are zone-redundant
    - Always use static allocation
- In Azure, a *public IP address prefix* is a reserved, static range of public ip addresses.
- In public IP addressing:
    - You can't specify addresses when you create a prefix, they're assigned by Azure.
    - You can't move IP address between regions.
- Private IP addresses can be set to dynamic (DHCP lease) or static (DHCP reservation)
- When your network expands, you don't want to redesign the IP address scheme.
- You'll need to isolates some services, which provides more security.
- Remember that Azure uses the first three addresses on each subnet. The first and last ip addresses of the subnets also are reserved for protocol conformance. Therefore, the number of possible addresses on an Azure subnet is (2^n)-5, where n represents the number of host bits.
## Distribute your services across Azure virtual networks and integrate them by using virtual network peering
- With peered virtual network, traffic between virtual machines are routed through the Azure network.
- Vnet peering features:
    - Reciprocal connections
    - Cross-subscription vnet peering
    - Transitivity
    - Gateway transit
    - Overlapping address space
    - Alternative connectivity methods
- To peer the vnets in different subscriptions, the administrator of each subscription should grant the **Network Contributor** role to the other administrator.
- Vnet peering is non-transitive.
- VPNs use the internet to connect your on-premises data center to the Azure backbone through and encrypted tunnel.
## Host your domain on Azure DNS
- Azure DNS enables you to host your DNS records for your domains on Azure infrastructure.
- Azure DNS is a hosting service for DNS domains that provide  name resoultion by using Microsoft infrastructure.
- A DNS server is also known as DNS name server, or just a name server.
- The DNS name server can resolve domain names to both IPV4 and IPV6 addressses.
- IPV6 is 8 groups of hexadecimal numbers separated by a colon.
- The following record types are most commonly created and used:
    - A
    - AAAA
    - CNAME
    - MX
    - TXT
- Today most important uses of DNS TXT records are:
    - Email span prevention
    - Domain Ownership verification
- Some record types support the concept of record sets. **A** record allows it while **SOA** and **CNAME** don't.
- Azure DNS acts as the SOA for the domain.
- Azure DNS do not support DNS security extensions.
- Azure DNS provides the following security features:
    - Role based access control
    - Activity logs
    - Resource locking
- Split horizon DNS support allows the same domain name to exist in both private and public zones. It resolves the correct one based on the originating request location.
- Changing the NS details is called domain delegation.
- **Apex domain** is the highest level of your domain. eg: krishnamohan.dev
- Apex domain is also referred to as *zone apex* or *root apex*. It's often represented by the @symbol in your DNS zone records.
- Azure alias records enable a zone apex domain to reference other Azure resources from the DNS zone.
- The Azure alias record can point to the following Azure resources.
    - A traffic manager profile
    - Azure content delivery network endpoints
    - A public IP resource
    - A front door profile.
- Advantages of using alias records:    
    - Prevents dangling DNS records
    - Updates DNS record set automatically when IP address change
    - Host load balanced applications at the zone apex.
    - Points zone apex to Azure content delivery network endpoints
## Manage and control traffic flow in your Azure deployment with routes
- In addition to the default system routes, azure will add other system routes if the following capablilities are enabled:
    - Virtual network peering
    - Service chaining
    - Virtual network gateway
    - Virtual network service endpoint
- You have two options to create custom routes: 
    - Create a user-defined route
    - use BGP to exchange routes between Azure and on-premises network.
- When creating user-define routes, you can define the following next hop types:
    - Virtual applicance
    - Virtual network gateway
    - Virtual network
    - Internet 
    - None
- BGP is the standard routing protocol that is normally used to exchange routing and information among two or more networks.
- If multiple routes are available in a route table, Azure uses the route with the longest prefix match.
- You can't configure **multiple user-defined routes** with the same address prefix.
- If there are **mulitple routes** with same address prefix, Azure selects the routes based on the following order:
    - User defined routes
    - BGP routes
    - System routes
- A network virtual appliance (NVA) is a virtual appliance that consists of various layers like:
    - a firewall
    - a WAN optimizer
    - application-delivery controllers
    - routers
    - load balancers
    - IDS/IPS
    - proxies
- With microsegmentation approach, you can create dedicated subnets for firewall and then deploy web applications and other services in other subnets.
- Microsegmentation lets the firewall inspect all packets at OSI Layer 4 and for application-aware appliances, layer 7.
## Improve applicaiton scalability and resiliency by using Azure Load Balancer
- With load balancer you can use, availabilty set and availability zones to ensure that VMs are always available.
- Two products are available whenyou create a load balancer in Azure: Basic and Standard.
- Basic load balancer can only used with single availability set or scale set.
- If you want to use load balancer with your remote desktop servers, use source ip affinity
- You can configure an internal load balancer same as external with these differences:
    - For the **Type** value, select **Internal**.
    - Assign private ip instead of public ip address
    - Place the load balancer in protected vnet that contains the vms you want to handle the requests.
