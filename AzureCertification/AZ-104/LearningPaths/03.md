# AZ-104: Implement and manage storage in Azure
## Configure Storage Accounts
- Azure storage offers a massively scalable object store for data objects, a file system service for the cloud, a messaging store for reliable messaging, and a NoSQL store.
- General purpose storage accounts have two tiers: **Standard** and **Premium**
    - Standard: Magnetic Disk -> Suitable for large infrequently accessed data.
    - Premium: SSD -> Suitable for high I/O applications like databases.
- You can't convert a Standard storage account to Premium and vice versa. You must create a new storage account with the desired type and copy data. 
- Azure storage is
    - Durable and highly available
    - Secure
    - Scalable
    - Managed
    - Accessible
- Azure Storage can be generally categorised into three:
    - **Storage for Virtual machines**: Disks and files for VMs
    - **Unstructured Data**: Blobs & Data Lake Store
    - **Structured Data**: Tables, Cosmos DB & Azure SQL
- Azure storage includes the following data services:
    - Azure Blobs
    - Azure Files
    - Azure Queues
    - Azure Tables
- Blob storage is ideal for storing images or documents, audio or video and backups.
- Azure files enable you to setup highly available network files shares that can be access by using standard Server Message Block (SMB) protocol.
- Shared Access Signature (SAS) tokens will allow specific access to a private asset for a specific amount of time.
- You can't mount Azure Blob Storage as a native share on a VM. You need to use Azure files for that.
- Server Message Block (SMB) is a communication protocol that Microsoft created for providing shared access to files and printers across nodes on a network.
- Diagnostic logs, metrics and crash dumps are just three examples of data that can be writtern to a file share and processed or analyzed later.
- Queues are used to store list of messages to be processed asynchronously.
- Queue messages can be upto 64KB in size. 
- Table storage is ideal for storing structured, non-relational data.
- All storage accounts are encrypted using Storage Service Encryption (SSE)  for data at rest.
- **Locally Redundant Storage (LRS)** is the low-cost least durable option. If a datacentre fails, all replicas may be lost or unrecoverable.
- Zone Redundant Storage (ZRS) synchronously replicate your data across three storage clusters in a single region. 
- Changing to ZRS from other replication option requires physical data movement.
- Geo Redundant Storage (GRS) replicates your data to a secondary region. GRS is designed to provide at least 16 9's durability. 
- With RA-GRS, you can read from the secondary region regardless of whether Microsoft initites a failover from the primary to secondary.
- Data in Geo-Zone Redundant Storage (GZRS) account is replicated across three Azure availabilty zones in primary region and also replicated to a secondary region.
- Every object you store in Azure storage has a unique URL address.
- Azure storage doesn't yet natively support HTTPS with custom domains. You can currently use Azure CDN to access blobs by using custom domains over HTTPS.
- Mapping a domain that is already in use within Azure may result in minor downtime as the domain is updated. To avoid downtime, you can use the asverify subdomain to validate the domain.
- Firewalls and Virtual networks restricts access to the storage account from specific subnets on virtual networks or public ip.
- Subnets and virtual networks must exist in the same Azure region or region pair as the storage account.
- Name of the storage account must be globally unique due to its usage as subdomain in the url.
## Configure blob storage
- Blob storage offers three type of resources:
    - The storage account
    - Containers in storage account
    - Blobs in a container
- Within the storage account you can group as many blobs as needed in a container.
- All blobs must be in a container.
- **Public Access Level** specifies whether data in the container may be accessed publicly.
    - Use **Private** to ensure that there is no anonymous access to the container or blobs.
    - Use **Blob** to allow anonymous public access to blob
    - Use **Container** to allow anonymous public read and list access to the entire container including blobs.
- Blob access tiers:
    - Hot - Suitable for frequent access
    - Cold - For data stored for atleast 30 days
    - Archive - For data stored for atleast 180 days.
- New storage accounts are created in Hot tier by default.
- The lifecycle management policy lets you:
    - Transition blobs to a cooler storage tier
    - Delete blobs at the end of their life cycle.
    - Define rules to be run once per day at the storage account level.
    - Apply rules to containers or subset of blobs.
- Object replication is only supported when the source and destination accounts are in hot or cool tier.
- Azure storage offers three types of blobs: 
    - Block blobs - Ideal for text and binary data
    - Page blobs - can be upto 8 TB and ideal for frequent read/write access
    - Append blobs - Ideal for logging
- Once the blob has been created, its type cannot be changed.
- When using a storage account, the following billing considerations apply.
    - Performance tiers
    - Data access costs
    - Transaction costs
    - Geo-replication data transfer costs
    - Outbound data transfer costs
    - Changing the storage tier.
- Object replication requires versioning to be enabled.
- Object replication doesn't support blob snapshots.
## Configure storage security
- All data written to Azure storage is automatically encrypted using Storage service encryption (SSE).
- Data can be secured in transit between application and azure by using client-side encryption, https or SMB 3.0
- OS and data disks used by Azure virtual machine can be encrypted using Azure Disk Encryption.
- SAS provide granular access control to your storage, while access key gives you full rights to everything in your storage account.
- Options for authorizing requests to Azure storage include: 
    - Azure AD
    - Shared Key
    - Shared access signatures
    - Anonymous accesss to containers and blobs
- A shared access signature (SAS) is a URI that grants restricted access rights to Azure storage resources.
- SAS provide both **account-level** and **service-level** control.
- Optionally in SAS, you can also, 
    - Specify ip address or a range of address from which Azure storage will accept SAS.
    - specify the protocol over which Azure storage will accept the SAS.
- The signature is an HMAC computer over a string-to-sign and key using the SHA256 algorithm, and then encoded using base64 encoding.
- SSE is enabled for all new and existing storage accounts and cannot be disabled.
- The storage account and key vault must be in the same region, but they can be in different subscriptions.
- The default network rule when configuring network access to an Azure storage account is to allow all collections from all networks.
- Access keys provide unrestricted access to storage resources.
## Configure Azure Files and Azure file sync
- File Storage offers shared storage for applications using industry standard SMB protocol.
- Any number of Azure Virtual machines or roles can mount and access the file storage share simultaneously.
- Azure files are true directory objects, azure blobs are flat namespaces.
- Azure files are accessed through file shares. Azure blobs are accessed through a container.
- Azure files use SMB protocol which uses TCP port 445. Ensure your firewall is not blocking TCP ports 445.
- Azure file shares can be mounted in linux distributions using the CIFS kernel client.
- Any request with HTTP is rejected when *secure transfer required* is enabled.
- Azure files - share snapshot capture a point-in-time, readonly copy of your data. 
- Share snapshots are incremental in nature.
- User **Azure Filesync** to centralize your organizations files shares in Azure files.
- A **Storage sync service** can create sync groups that contain Azure file shares across multiple storage accounts and multiple registered windows servers.
- High level steps for configuring Azure file sync
    - Deploy the storage sync service
    - Prepare windows servers
    - Install the file sync agent
    - Register the windows server
- Cloud tiering allows frequently accessed files to be cached on the local server. Infrequently accessed files are tiered, or archived, to the Azure file share according to the policy created.
## Configure Azure storage with tools
- Azure storage explorer is a standalone app that makes it easy to work with Azure storage data on Windows, linux and macOS.
- Use storage explorer to manage local storage by using Azure storage emulator.
- You are provided two access keys so that you can maintain connections using one key while regenerating the other.
- **Azure import/export service is used to securely import large amounts of data to Azure Blob Storage and Azure files by shipping disk drives to an Azure data center.
- For sending data over disks, use **WAImportExport** tool to copy the data and **Bitlocker** to encrypt the drive and generate journal files.   
- **AzCopy** v10 is the next-generation commandline utility for copying data to/from Microsoft Azure Blob and File Storage.
## Create an Azure Storage account
- A **storage account** is a container that groups a set of Azure services together.
- Deleting a storage account deletes all of the data stored inside it.
- Other Azure data services such as Azure SQL and Azure Cosmos DB, are managed as independent Azure resources and cannot be included in a storage account.
- Storage account settings:
    - Subscription
    - Location
    - Performance: Standard/Premium
    - Replication
    - Access tier: Hot/Cold/Archive
    - Secure transfer required
    - Virtual network
- The number of storage accounts you need is typically determined by your data diversity, cost sensitivity and tolerance for management overhead.
- A typical strategy is to start with an analysis of your data and create partitions that share characteristics like location, billing and replication strategy, and then create one storage account for each partition.
- Three settings that apply to account itself rather than data stored in the account:
    - Name
    - Deployment model
    - Account kind
- Azure provides two deployment models"
    - Resource Manager: (Recommended) uses Azure Resource Manager API
    - Classic: uses Azure Service management API
- There are three kinds of storage accounts
    - StorageV2 (Recommended)
    - Storage
    - Blob
- Storage account name is used as part of the URI for API access, so it must be globally unique.
## Control access to Azure storage with shared access signatures
- Files stored in Azure storage are accessed using HTTP/S.
- Azure checks each client request for authorization to access stored data. Four options are available for blob storage: 
    - Public access
    - Azure AD
    - Shared key
    - Shared access signature
- Both storage account and container settings are required to enable anonymous public access.
- Azure storage supports three types of shared access signatures:
    - User delegation SAS
    - Service SAS
    - Account SAS
- A stored access policy can be associated with up to five active SASs.
- Most secure SAS is user delegation.
- A stored access policy is created with the following properties:
    - Identifier
    - Start time
    - Expiry time
    - Permissions
- You can have up to five stored access polices on a blob container.
## Upload, download and manage data with Azure storage explorer
- Storage explorer lets you connect to Data lake storage
- Azure data lake storage gen2 is Azure blob storage with the hierarchicial namespace feature enabled on the account.
- Storage explorer helps to manage multiple storage account in multiple subscriptions.
- Storage explorer supports two emulators: 
    - **Azure storage emulator** - SQL Server 2012 Express localDB
    - **Azurite** - Opensource
- You need two permissions to access your Azure storage account: management and data.
