# AZ-104: Deploy and manage Azure compute resources
## Configure Virtual Machines
- Azure Virtual machines provide you with an operating system, storage and networking capabilities and can run a wide range of applications.
- Virtual machines are part of infrastrcutre as a code (IAAS) offering.
- IAAS business scenarios
    - Test and development
    - Website Hosting
    - Storage, backup and recovery
    - High performance computing
    - Big data analysis
    - Extended Datacenter
- Provisioning VMs to Azure requires planning:
    - Start with the network
    - Name the VM
    - Decide the locatio for the VM
    - Determine the size of the VM
    - Understanding the pricing model
    - Storage of the VM
    - Select an operating system
- Virtual networks (VNets) are used in Azure to provide private connectivity between Azure Virtual Machine and other Azure services.
- You can have upto 15 character name on windows VM and 64 character name on linux machine.
- A good convention is to include the following details in the VM's name
    - Environment
    - Location
    - Instance
    - Product or Service
    - Role
- There are two separate costs the subscription will be charged for every VM: Compute and storage. 
- Compute expenses are prices on a per-hour basis but billed on a per-minute basis.
- The status of VM has no relation to storage charges.
- You're able to choose from two payment option for compute costs: 
    - Consumption based
    - Reserved Virtual Machine instances
- The best way to determine the appropriate VM size is to consider the type of workload. 
- Workload options are classified as follows:
    - General Purpose
    - Compute Optimised
    - Memory Optimised
    - Storage Optimised
    - GPU
    - High Performance Compute
- Be cautious when resizing in production, it may cause downtime due to restart
- All azure VMs have atleast two disks:
    - Operationg system disk
    - Temporary disk
- VMs amy containe one or more data disks.
- All disks are stored as Virtual Hard disks (VHD)
- OS disk is registerd as SATA drive and labeled as C: drive by default.
- Don't store data on temporary disks
- Data disks are registerd as SCSI drives and are labeled with a letter that you choose.
- Premium storage disks uses SSD.
- Azure offers two ways to create premium storage disks: 
    - Unmanaged disks - User manage the storage account of VHD
    - Managed disks
- Managed disks are required for the single instance VM SLA.
- Virtual machine configuration:
    - **Basic** - Project details, Administrator account, Inbound port rules
    - **Disks** - OS disk type, data disks
    - **Networking** - Virtual Network, load balancing
    - **Management** - Monitoring, Auto shutdown, backup
    - **Advanced** - Agents, scripts or cloud init, Additional configurations
- You can connect to VM in the following ways
    - Using RDP for windows server
    - Using SSH for linux server
    - Using Bastion to get RDP/SSH connectivity from Azure portal over SSL.
- By default, Windows Remote Management (RM) uses TCP port 5986. You can change port, but make sure that it is not blocked by network group rules.
- Azure currently requires atleast a 2048-bit key length and the SSH-RSA format for public and private keys.
- Outbound request and inbound request within the virtual network is allowed by default for VM.
## Configure Virtual Machine availability
- There are three scenarios that can affect your VM:    
    - Unplanned hardware maintenance
    - Unexpected downtime
    - Planned maintenance
 - Azure uses live migration technology to migrate VMs from failing hardware to healthy hardware.
 - An **availablitly set** is a logical feature used to ensure that all VMs in the group aren't subject to a single point of failure.
 - VMs placed in an availability set should perform identical set of functionalities.
 - A VM can only be added to an availabilty set at the time of creation. So to change the availabilty set you need to delete and recreate the VM.
 - General principles of availabilty sets:
    - For redundancy, Configure multiple VMs in the availability set.
    - Configure a load balancer for the availability set.
    - Configure each applicatio tier to different set.
    - Use managed disks with VMs.
- An **Update domain** is a group of nodes that are upgraded together during the process of a service upgrade.
- A **fault domain** is a group of nodes that represent a physical unit of failure. Think of fault domain as nodes belonging to the same physical rack.
- Each VM is an availability set is placed in one update domain and one fault domain.
- By default there are 5 update domain, but we can configure upto 20.
- Availabilty zones are high availablity offering that protects your applications and data from data center failures.
- Availabilty zone considerations
    - Unique physical location in a region
    - Each zone has independant power, cooling and networking.
- Azure services that support availability zones fall into two categories.
    - Zonal Services - eg: VM, disks
    - Zone-redundant services - eg: SQL DB
- Generally there are two types of scaling
    - Vertical scaling
    - Horizontal scaling
- Reprovisioning means removing an exisiting VM and replacing it with a new one.
- vertical scaling has more limitations, horizontal scaling is more flexible.
- Virtual machine scale sets are an azure compute resource you can use to deploy and manage a set of identical VMs. It support true auto-scale.
- Scale sets support the use of Azure load balancer for basic layer-4 traffic distribution, and Azure application gateway for more advanced layer-7 traffic distribution and SSL termination.
- Scale sets support upto 1k VM, 600 VMs is custom image.
- When you create a scale set consider these parameters:
    - Initial instance count
    - Instance size
    - Azure spot instance
    - Use managed disks
    - Enable scaling beyond 100 instances
    - Spreading algorithm
- Configure autoscale with these parameters:
    - Minimum number of VMs
    - Maximum number of VMs
    - Scale out threshold
    - Number of VMs to increase by
    - Scale in threshold
    - Number of VMs to decrease by
## Configure Virtual Machine extensions
- Virtual Machine extensions will help you to avoid configuration drift.
- Azure virtual machine extensions are small applications that provide post-deployment configuration and automation tasks on Azure VMs.
- Azure VM extensions can be managed with CLI, Powershell, ARM templates and Azure portal.
- **Custom Script Extension** (CSE) can be used to automatically launch and execute virtual machine customization tasks post configuration.
- CSE considerations: 
    - Timeout: CSE have 90 mins to run
    - Dependencies
    - Failure events
    - Sensitive data
- **Desired state configuration** (DSC) is a management platform in windows powershell. 
- DSC enables deploying and managing configuration data for software services and managing the environment in which these services run.
- DSC script consists of configuration block, node block and one or more resource block.
## Configure App service plans
- Your scaling choices depend on app service plan.
- Azure app service is an HTTP-based service for hosting web applications, REST APIs, and mobile backends.
- Each app service plan defines:
    - Region
    - Number of VM instances
    - Size of VM instances
- Isolate your app to a new App service plan when: 
    - The app is resouce-intensive
    - You want to scale the app independently from the other apps in the existing plan
    - The app needs resource in a different geographical region.
- App service pricing tiers
    - Free
    - Shared - For dev/test
    - Basic - dev/test
    - Standard - has autoscale
    - Premium
    - Isolated - for mission critical
- If your app depends on Azure DB or Azure storage you can scale it separately.
- Autoscale settings rule include a trigger and a scale action. 
- The trigger can be metric-based or time-based.
- Auto-scale can notify one or more email address or make calls to one or more webhooks.
## Configure Azure App Services
- Reasons to use App services:
    - Multiple languages and frameworks
    - DevOps Optimization
    - Global Scale with high availability
    - Connections to Saas platforms and on-premises data
    - Security and compliance
    - Application templates
    - Visual Studio integration
    - API and mobile features
    - Serverless code
- When creating an app service, you'll need to provide:
    - Resource Group
    - Service Plan
    - Name
    - Publish (Code/Docker)
    - Runtime Stack
    - Operating System 
    - Region
    - Addtional Settings
        - Always On (for no traffic scenarios)
        - ARR Affinity
        - Connection strings
- App service provide out of the box CI and CD.
- Options to manually push your code to Azure:
    - Git
    - CLI
    - Visual Studio
    - FTP/S
- If you're in standard, premium or isolated tier you can make use of a separate deployment slot in addition to the default production slot. 
- Deployment slts are live apps with their own host names.
- Auto swap isn't currently supported in web apps in linux.
- New deployment slots can be empty or cloned
- Deployment slot settings fall into three categories
    - Slot specific app settings and connection strings
    - Continuous deployment settings
    - App service authentication settings
- Azure app service provides built-in authentication and authorization support, but you're not required to use it as many web framworks are bundled with it.
- If you enable application logging, you will see authentication and authorization traces directly in your log files.
- When you create a web app, Azure assigns it to a subdomain of **azurewebsites.net**.
- Backup and restore feature is available only in Standard/Premium tier.
- Backups can be upto 10GB of app and database content
- Using firewall enabled storage account as the desitnation for your backups is not supported.
- Application insights features
    - Reuqest rates, resonse times and failure rates
    - Dependency rates, response times and failure rates
    - Exceptions
    - Page views and load performance
    - User and session counts
    - Performance coutners
    - Host diagnostics
    - Diagnostic trace logs
    - Custom events and metrics
## Configure Azure Container instances
- Containers offer a standard and repeatable way to package, deploy and manage cloud applicatins.
- Container-based virtualization allows you to virtualize operating system. (Otherwise hardware virtualization).
- Containers offer several adavantages over physical and virtual machines:
    - Increase flexibility and speed
    - Simplified application testing
    - Improved resource utiliazation.
- Azure conatiner instances features:
    - Fast startup times
    - Public IP connectivity and DNS names
    - Hypervisor level security
    - Custom sizes
    - Persistent storage
    - Linux and windows containers
    - Coscheduled groups
    - Virtual network deployment
- The top-level resource in Azure Container instances is the container group. A container group is a collection of container that get scheduled on the same host machine. The containers in a container group share a lifecycle, resources, local network, and storage volumes. It's similar in concept to a pod in Kubernetes.
- Two common ways to deploy multi-container group: ARM template and YAML file.
- Container group is suitable for sidecar pattern.
- Acontainer is essentially a standalone package that contains everything that is needed to execute a piece of software. The package includes:
    - The application executable code
    - The runtime environment
    - System tools
    - Settings
## Configure Azure K8S Service
- AKS Terminology
    - **Pods** are single instances of an application. A pod can contain multiple containers
    - **Nodes** are individual virtual machines running containerized applications.
    - **Pools** are groups of nodes with identical configurations
    - **Manifest** is the YAML file describing a deployment.
- A K8s cluster is divided into two components:
    - Azure managed nodes
    - Customer managed nodes
- **kubelet** is the k8s agent that processes the orchestration requests from the Azure managed node, and scheduling of running the requested containers.
- Virtual networking is handled by the **kube-proxy** on each node.
- K8s version 1.19 and greater uses *containerd* as container runtime, prior versions use *Moby*.
- Security and filtering of the network traffic for pods is possible with k8s network policies.
- K8s uses Serivces to logically group a set of pods together and provide network connectivity. The following service types are available:
    - Cluster IP - suitable for internal applications
    - NodePort
    - LoadBalancer
    - ExternalName
- **Pods** typically have a 1:1 mapping with a container, although there are advanced scenarios where a pod might contain multiple containers.
- Concepts that provide storage to your applicaiton in AKS
    - Volumes
    - Persistent volumes
    - Storage classes
    - Persistent volumen claims
- Volumes can use Azure files or Azure disks
- Azure disks are mounted as *ReadWriteOnce*, so only available to a single node. Use Azure files for multiple files.
- Azure files let you share data across multiple nodes and pods.
- A *persistent volume* is a storage resource created and managed by the Kubernetes APi that can exist beyond the lifetime of and individual pod.
- **StorageClass* define *reclaimPolicy* which controls the behaviour of the underlying Azure storage resource when the pod is deleted and the persisitent volume may no longer be required.
- In AKS, four initial storageClasses are created for cluster using the in-tree storage plugins:
    - default
    - managed-premium
    - azurefile
    - azurefile-premium
- There is a 1:1 mapping of persistent volumes to claims. 
- K8s uses the horizontal pod autoscaler (HPA)  to monitor the resource demand and automatically scale the number of replicas.
- HPA checks Metrics API every 30 seconds.
- **Cooldwon or delay values** define how long the horizontal pod autoscaler must wait after a scale event before another scale event can be triggered.
- Cluster autoscaler adjusts the number of nodes based on the requested compute resources in the ndoe pool. By default, cluster autoscaler checks the API every 10 seconds.
- Azure Container Instances (ACI) lets you quickly deploy container instances without more infrastructure overhead.
- Virtual nodes are only supported with Linux pods and nodes.
## Manage VMs with Azure CLI
- Common names such as "root" and "admin" as admin usernames are not allowed for most images.
- Some vm images are available only in some specific locations. Use `--location` flag to filter that.
- You can change the output style for any response through `--output` flag. Supported types:
    - table
    - json
    - jsonc (colorized)
    - tsv
- Use full option name is scripts for clarity. eg: --output instead of -o
- JMESPath is an industry standard query language built around JSON objects.
- Query technique works with any Azure CLI command.
- To stop a VM with CLI, you need to pass either name and resource group or unique id.
- Add `--no-wait` if you want the script to move immediately to the next command.
## Create a Windows virtual machine in Azure
- Resources used in a windows VM:
    - A vm that provides cpu and memory resources
    - An azure storage account to hold the virtual hard disks
    - Virtual disks to hold the OS, applications and data
    - Virtual network to connect the VM to other services 
    - A network interface
    - A public ip, but optional
- VM sizes are grouped into categories, starting with the B-series for basic testing and running up to the H-series for massive computing tasks.
- Guidelines for size:
    | What are you doing            | Consider these size |
    |-------------------------------|---------------------|
    |  General use computing /Web   |   B, Dsv3, Dv3      |
    |Heavy Computational tasks      | Fsv2, Fs, F         |
    |Large Memory Usage             | E, M, G, D          |
    |Data Storage & processing      | L                   |
    |Heavy graphics rendering       | N                   |
    |High performance computing     |            H        |
- You can store data on the C: drive along with the OS, but a better approach is to create dedicated data disks.
- If the disks are unmanaged you are responsible for the storage accounts that used to hold the disk.
- Single storage account is capable of supporting 40 standard virtual hard disks at full throttle.
- Managed disks benefits
    - Increase reliability
    - Better security
    - Snapshot support
    - Backup support
- It is better to plan your network requirements up-front and create a Vnet before creating a VM.
- Microsoft provides RDP clients for: Windows, macOS, iOS, android.
- When you connect to a VM with RDP, you'll typically receive two warnings. These are:
    - Publisher warning: 
    - Certificate warning
- **Network Security Groups** are the main tool you use to enforce and control network traffic rules at the networking level.
- Security groups are optional. If no security group is applied, the all traffic is allowed by Azure.
- SMTP (port 25) is a special case, depending on your subscription level and when your account was created, outbound SMTP traffic may be blocked. You can make a request to remove this restrictio with business justification.
- **Deny All** is the final rule that is applied in every network security group.
## Host a web application with Azure App service
- Azure App Service is a fully managed web application hosting platform (PaaS).
- Azure portal provides out-of-the-box continuous integration and support with Azure DevOps, Github, Bitbucket, FTP or local git repository on your development machine.
- If your application is packed as a Docker image, select the OS on which your images is designed to run.
- Application Insights are available from linux-hosted apps, but a turnkey, no-code option is available only in windows.
- The number of web apps deployed to your App Service has no effect on your bill.
## Protect your VM settings with Azure Automation State Configuration
- Azure Automation State Configuration (AASC) address many of the problems (like VM *drift*) associated with deploying at scale and managing configuration drift.
- AASC has a built in pull server.
- **Powershell DSC** is a declarative management platform that AASC uses to configure, deploy and control systems.
- The Local Configuration Manager (LCM) is a component of Windows Management Framework (WMF) on a windows operating system, that is reponsible for updating the state of a node, like a VM, to match the desired state.
- Every time the LCM runs, it completes the following steps:
    - Get
    - Test
    - Set
- *.mof file is compiled DSC script.
- The LCM on each node can operate in two modes:
    - Push mode - easy to setup
    - Pull mode - for enterprise, need dedicated infrastructure
- Powershell DSC script describes the desired state.
- A DSC code block contains four sections:
    - Configuration
    - Node
    - Resource
    - MyDscConfiguration
- Node block determines the name of the .mof files that are generated when you compile the configuration.
- DSC Configurations in Azure automation can refernce credentials stored in a `PSCredential` object.    
